<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Trade</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; padding: 20px; }
    h1 { color: #0f0; }
    .card { background: #222; padding: 10px; margin: 10px 0; border-left: 5px solid #0f0; }
    button { padding: 10px; margin: 10px 0; background: #0f0; color: #000; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>📈 Painel do Bot de Trade</h1>
  <button onclick="toggleMode()">🔁 Alternar Modo</button>
  <div id="log"></div>

  <canvas id="btcChart" width="400" height="200"></canvas>
  <canvas id="xrpChart" width="400" height="200"></canvas>
  <canvas id="dogeChart" width="400" height="200"></canvas>

  <h2>💰 Saldo</h2>
  <ul id="wallet"></ul>

  <script>
    const log = document.getElementById("log");
    const wallet = document.getElementById("wallet");
    const socket = new WebSocket("ws://localhost:8080");

    const charts = {
      BTCUSDT: createChart("btcChart", "BTC/USDT"),
      XRPUSDT: createChart("xrpChart", "XRP/USDT"),
      DOGEUSDT: createChart("dogeChart", "DOGE/USDT")
    };

    function createChart(id, label) {
      const ctx = document.getElementById(id).getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label,
            data: [],
            borderColor: "lime",
            backgroundColor: "rgba(0,255,0,0.2)",
            tension: 0.3
          }]
        },
        options: {
          scales: {
            x: { display: false },
            y: { beginAtZero: false }
          }
        }
      });
    }

    function toggleMode() {
      socket.send("toggle-mode");
    }

     socket.onmessage = (event) => {
      let data;
      try {
        data = JSON.parse(event.data);
      } catch {
        const msg = document.createElement("div");
        msg.className = "card";
        msg.textContent = event.data;
        log.prepend(msg);
        return;
      }

      if (data.type === "balance") {
        wallet.innerHTML = "";
        for (const [asset, value] of Object.entries(data.saldo)) {
          const li = document.createElement("li");
          li.textContent = `${asset}: ${value.toFixed(4)}`;
          wallet.appendChild(li);
        }
      }

      if (data.symbol && data.price) {
        const chart = charts[data.symbol];
        if (chart) {
          chart.data.labels.push(new Date().toLocaleTimeString());
          chart.data.datasets[0].data.push(data.price);
          if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
          }
          chart.update();
        }
      }
    };
  </script>
</body>
</html>
